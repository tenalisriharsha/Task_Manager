<!-- File: templates/base.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Clubhouse</title>
  <!-- Simple CSS framework (PicoCSS) for clean look -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* File: static/css/app.css (inline for brevity) */
    .board { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
    @media(max-width: 800px) { .board { grid-template-columns: 1fr; } }
    .column { background: #f8f9fb; padding: .75rem; border-radius: .6rem; min-height: 200px; }
    /* Scrollable board lanes */
    .board-columns { display: flex; gap: 24px; align-items: flex-start; }
    .board-col { flex: 1; min-width: 260px; }
    .board-col .col-body {
      max-height: calc(100vh - 260px); /* keeps columns from stretching */
      overflow-y: auto;                 /* enable scrolling inside the lane */
      padding: 12px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    /* Scrollable leaderboard container */
    .leaderboard-scroll { max-height: 360px; overflow-y: auto; }
    /* Scrollable history container */
    .history-scroll { max-height: 60vh; overflow-y: auto; }
    /* Table helpers */
    .leaderboard-scroll thead tr { position: sticky; top: 0; background: #fff; z-index: 1; }
    .num { text-align: right; }
    .card { background: white; border: 1px solid #e5e7eb; padding: .75rem; border-radius: .6rem; margin-bottom: .75rem; }
    .badge { background: #eef; padding: 0 .5rem; border-radius: 999px; font-size: .8rem; }
    /* Flash messages (level-based) */
    .flash{padding:.55rem .8rem;border-radius:.55rem;border:1px solid #ddd;margin:.4rem 0}
    .flash[data-level*="success"]{background:#e6ffec;border-color:#b7f0c2}
    .flash[data-level*="info"]{background:#e9f3ff;border-color:#c9dcff}
    .flash[data-level*="warning"]{background:#fff7e6;border-color:#ffe0a3}
    .flash[data-level*="error"]{background:#ffe9e9;border-color:#ffc7c7}
    nav ul { align-items: center; }
    .linklike { background: none; border: none; padding: 0; color: inherit; text-decoration: underline; cursor: pointer; font: inherit; }
  </style>
</head>
<body>
  <nav class="container-fluid">
    <ul>
      <li><strong>üè† Clubhouse</strong></li>
    </ul>
    <ul>
      {% if user.is_authenticated %}
        <li><a href="{% url 'tasksapp:home' %}">Home</a></li>
        <li><a href="{% url 'elections:current' %}">Election</a></li>
        {% if user.is_superuser or user.is_staff %}<li><a href="{% url 'core:admin_panel' %}">Admin</a></li>{% endif %}
        <li><a href="{% url 'accounts:profile' %}">Profile</a></li>
        <li><a href="{% url 'tasksapp:history' %}">Tasks History</a></li>
        <li><span class="badge">Leader: {{ SITE.current_leader.username|default:"‚Äî" }}</span></li>
        <li>
          <form method="post" action="{% url 'accounts:logout' %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="linklike">Logout</button>
          </form>
        </li>
      {% else %}
        <li><a href="{% url 'accounts:login' %}">Login</a></li>
        <li><a href="{% url 'accounts:signup' %}">Signup</a></li>
      {% endif %}
    </ul>
  </nav>

  <main class="container">
    {% if messages %}
      <div id="flash-zone">
        {% for m in messages %}
          <div class="flash" data-level="{{ m.tags|default_if_none:'info' }}">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

  <script>
    // CSRF setup for HTMX: attach Django's csrftoken cookie to all HTMX requests
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'));
      return match ? match.pop() : '';
    }
    document.body.addEventListener('htmx:configRequest', function (e) {
      e.detail.headers['X-CSRFToken'] = getCookie('csrftoken');
    });

    // HTMX client-side effects
    document.body.addEventListener('approved-confetti', function () {
      confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
    });
    document.body.addEventListener('star-awarded', function () {
      // subtle burst
      confetti({ particleCount: 40, spread: 50, origin: { y: 0.7 } });
    });
    // Tiny confetti burst when a success message is present
    (function(){
      const ok = document.querySelector('.flash[data-level*="success"]');
      if(!ok) return;
      confetti({ particleCount: 90, spread: 65, origin: { y: 0.7 } });
    })();

    // ---------- live countdowns on task cards ----------
    (function countdownTick(){
      const nodes = document.querySelectorAll('[data-countdown]');
      const now = Date.now();
      nodes.forEach(el => {
        const targetStr = el.getAttribute('data-countdown');
        const target = Date.parse(targetStr);
        if (isNaN(target)) return; // ignore bad dates
        const diff = target - now;

        // Format helper
        const fmt = (ms) => {
          if (ms <= 0) return 'Expired';
          const s = Math.floor(ms / 1000);
          const d = Math.floor(s / 86400);
          const h = Math.floor((s % 86400) / 3600);
          const m = Math.floor((s % 3600) / 60);
          const sec = s % 60;
          if (d > 0) return `${d}d ${h}h ${m}m`;
          if (h > 0) return `${h}h ${m}m`;
          if (m > 0) return `${m}m ${sec}s`;
          return `${sec}s`;
        };

        el.textContent = fmt(diff);

        // When expired: mark card and disable completion button
        const card = el.closest('.card');
        const btn = card ? card.querySelector('.btn-complete') : null;
        if (diff <= 0) {
          if (card) card.classList.add('expired');
          if (btn) { btn.disabled = true; btn.classList.add('disabled'); }
          el.textContent = 'Expired';
        }
      });
      setTimeout(countdownTick, 1000);
    })();
  </script>
</body>
</html>
